stages:
  - test
  - build
  - deploy-staging
  - deploy-production

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}

test:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t test-image .
    - docker run test-image npm test || true
  only:
    - branches

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t ${IMAGE_TAG} .
    - docker push ${IMAGE_TAG}
  only:
    - main
    - develop

deploy-staging:
  stage: deploy-staging
  image: alpine:latest
  script:
    - echo "Deploying to staging..."
    - apk add --no-cache curl
    # Add staging deployment commands
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop

deploy-production:
  stage: deploy-production
  image: alpine:latest
  script:
    - echo "Deploying to production..."
    # Add production deployment commands
  environment:
    name: production
    url: https://example.com
  when: manual
  only:
    - main
